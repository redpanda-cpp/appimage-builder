name: Build

on: [push, pull_request]

jobs:
  download_source:
    name: Download source
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Download source
        run: |
          ./main.py --arch x86_64 --branch main --download-only
          ./main.py --arch x86_64 --branch time32 --download-only

      - uses: actions/upload-artifact@v4
        with:
          name: src
          path: |
            assets

  build_container_base:
    name: Build container base
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build container base
        run: |
          podman build \
            -t redpanda-cpp/basic-appimage-builder \
            container/_base

          podman save \
            -o basic-appimage-builder.tar \
            redpanda-cpp/basic-appimage-builder

      - uses: actions/upload-artifact@v4
        with:
          name: container-base
          path: |
            basic-appimage-builder.tar

  build:
    name: Build
    needs: [download_source, build_container_base]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
          - x86_64.v3
          - aarch64
          - riscv64
          - loong64
          - i686
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download source
        uses: actions/download-artifact@v4
        with:
          name: src
          path: assets

      - name: Build
        run: |
          if [[ "${{ matrix.arch }}" == "i686" ]]; then
            branch="time32"
          else
            branch="main"
          fi

          podman run \
            --platform linux/amd64 \
            --rm \
            --cap-add=sys_admin \
            --volume $PWD:/mnt \
            --workdir /mnt \
            docker.io/amd64/ubuntu:24.04 \
            bash -c \
              "./support/dep.sh && ./main.py -a ${{ matrix.arch }} -b $branch"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}
          path: container/${{ matrix.arch }}/qt.tar

      - uses: actions/download-artifact@v4
        with:
          name: container-base
          path: assets

      - name: Load container base
        run: |
          docker load -i assets/basic-appimage-builder.tar

      - uses: macbre/push-to-ghcr@master
        if: github.ref_type == 'tag'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          image_name: ${{ github.repository }}-${{ matrix.arch }}
          dockerfile: container/${{ matrix.arch }}/Dockerfile
          context: container/${{ matrix.arch }}
          image_tag: ${{ github.ref_name }}
